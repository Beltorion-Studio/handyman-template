---
import { getCollection, type CollectionEntry } from 'astro:content'
import { render } from 'astro:content'
import type { GetStaticPaths } from 'astro'
import Layout from '@layouts/Layout.astro'
import BlogSection from '@components/blog/BlogSection.astro'
import Prose from '@components/blog/Prose.astro'
import BlogHero from '@components/blog/BlogHero.astro'
import PostsSection from '@components/sections/PostsSection.astro'

type Props = {
  blog: CollectionEntry<'blogs'>
}

export const getStaticPaths = (async () => {
  const blogs = await getCollection('blogs', (blog) => blog.data.draft !== true)

  return blogs.map((blog) => ({ params: { slug: blog.id }, props: { blog } }))
}) satisfies GetStaticPaths

const { blog } = Astro.props
const { Content } = await render(blog)

// Get the raw markdown content for TOC extraction
const rawContent = blog.body

const allBlogPosts = await getCollection('blogs')
const blogPosts = allBlogPosts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
---

<Layout title={blog.data.title}>
  <BlogHero
    sectionId="hero"
    author={blog.data.author}
    date={blog.data.pubDate.toLocaleDateString()}
    heroImage={{ src: blog.data.heroImage, alt: blog.data.imageAlt }}
    title={blog.data.title}
    description={blog.data.description}
  />
  <BlogSection sectionId="blog-section" content={rawContent}>
    <Prose>
      <Content />
    </Prose>
  </BlogSection>
  <PostsSection
  badge="Blog"
  title="Latest Blog Posts"
  buttonText="View All Posts"
  buttonHref="/blogs"
  posts={blogPosts}
  postType="blog"
  maxPosts={3}
  sectionId="latest-blog-posts"
  background="bg-gradient-to-br from-primary-light/5 to-brand/5"
/>
</Layout>
